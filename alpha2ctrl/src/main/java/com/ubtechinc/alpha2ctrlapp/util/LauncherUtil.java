package com.ubtechinc.alpha2ctrlapp.util;

import android.content.ContentResolver;
import android.content.Context;
import android.content.Intent;
import android.content.pm.PackageInfo;
import android.content.pm.PackageManager;
import android.content.pm.PackageManager.NameNotFoundException;
import android.content.pm.ProviderInfo;
import android.content.pm.ResolveInfo;
import android.database.Cursor;
import android.net.Uri;
import android.text.TextUtils;

import com.orhanobut.logger.Logger;

import java.util.List;

public class LauncherUtil {
 
    private static String AUTHORITY = null;
 
    public static boolean isShortCutExist(Context context) {
 
        boolean isInstallShortcut = false;
        String title ="";
        final PackageManager pm = context.getPackageManager();
        try {
			title = pm.getApplicationLabel(pm.getApplicationInfo(context.getPackageName(), PackageManager.GET_META_DATA)).toString();
			if (null == context || TextUtils.isEmpty(title))
	            return isInstallShortcut;
	 
	        if (TextUtils.isEmpty(AUTHORITY))
	            AUTHORITY = getAuthorityFromPermission(context);
	 
	        final ContentResolver cr = context.getContentResolver();
	 
	        if (!TextUtils.isEmpty(AUTHORITY)) {
	            try {
	                final Uri CONTENT_URI = Uri.parse(AUTHORITY);
	                final Cursor c = context.getContentResolver().query(CONTENT_URI, null, "title=?", new String[] { title }, null);
	       
	 
	                // XXX表示应用名称。
	                if (c != null && c.getCount() > 0) {
	                    isInstallShortcut = true;
	                }
	                if (null != c && !c.isClosed())
	                    c.close();
	            } catch (Exception e) {
	                // TODO: handle exception
	                Logger.d("isShortCutExist", e.getMessage());
	            }
	 
	        }
		} catch (NameNotFoundException e1) {
			// TODO Auto-generated catch block
			e1.printStackTrace();
		}
        
        return isInstallShortcut;
 
    }
 
    public static String getCurrentLauncherPackageName(Context context) {
 
        Intent intent = new Intent(Intent.ACTION_MAIN);
        intent.addCategory(Intent.CATEGORY_HOME);
        ResolveInfo res = context.getPackageManager()
                .resolveActivity(intent, 0);
        if (res == null || res.activityInfo == null) {
            // should not happen. A home is always installed, isn't it?
            return "";
        }
        if (res.activityInfo.packageName.equals("android")) {
            return "";
        } else {
            return res.activityInfo.packageName;
        }
    }
 
    public static String getAuthorityFromPermissionDefault(Context context) {
 
        return getThirdAuthorityFromPermission(context,
                "com.android.launcher.permission.READ_SETTINGS");
    }
 
    public static String getThirdAuthorityFromPermission(Context context,
                                                         String permission) {
        if (TextUtils.isEmpty(permission)) {
            return "";
        }
 
        try {
            List<PackageInfo> packs = context.getPackageManager()
                    .getInstalledPackages(PackageManager.GET_PROVIDERS);
            if (packs == null) {
                return "";
            }
            for (PackageInfo pack : packs) {
                ProviderInfo[] providers = pack.providers;
                if (providers != null) {
                    for (ProviderInfo provider : providers) {
                        if (permission.equals(provider.readPermission)
                                || permission.equals(provider.writePermission)) {
                            if (!TextUtils.isEmpty(provider.authority)// 精准匹配launcher.settings，再一次验证
                                    && (provider.authority)
                                            .contains(".launcher.settings"))
                                return provider.authority;
                        }
                    }
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
        return "";
    }
 
    public static String getAuthorityFromPermission(Context context) {
        // 获取默认
        String authority = getAuthorityFromPermissionDefault(context);
        // 获取特殊第三方
        if (authority == null || authority.trim().equals("")) {
            String packageName = getCurrentLauncherPackageName(context);
            packageName += ".permission.READ_SETTINGS";
            authority = getThirdAuthorityFromPermission(context, packageName);
        }
        // 还是获取不到，直接写死
        if (TextUtils.isEmpty(authority)) {
            int sdkInt = android.os.Build.VERSION.SDK_INT;
            
            if (sdkInt < 8) { // Android 2.1.x(API 7)以及以下的
                authority = "com.android.launcher.settings";
            } 
            
//            else if (sdkInt < 19) {// Android 4.4以下
//                authority = "com.android.launcher2.settings";
//            } 
            else {// 4.4以及以上
                authority = "com.android.launcher2.settings";
            }
        }
        authority = "content://" + authority + "/favorites?notify=true";
        return authority;
 
    }
}